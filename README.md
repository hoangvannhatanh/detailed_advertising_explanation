# H∆Ø·ªöNG D·∫™N T√çCH H·ª¢P ADS - PHI√äN B·∫¢N R√öT G·ªåN

> **Th∆∞ vi·ªán**: vtn_ads_libs v2.x.x
> **Package**: com.github.devvtn:vtn_ads_libs:2.x.x

---

## üìå T·ªîNG QUAN

### Th∆∞ vi·ªán s·ª≠ d·ª•ng
```gradle
// Google Ads
implementation 'com.google.android.gms:play-services-ads:x.x.x'

// Facebook Mediation
implementation 'com.google.ads.mediation:facebook:6.x.x.x'
implementation 'com.facebook.android:facebook-android-sdk:x.x.x'

// VTN Ads Library
implementation 'com.github.devvtn:vtn_ads_libs:x.x.x'
implementation 'com.facebook.shimmer:shimmer:x.x.x'
```
- `play-services-ads`: **SDK ch√≠nh th·ª©c c·ªßa Google AdMob, d√πng ƒë·ªÉ hi·ªÉn th·ªã qu·∫£ng c√°o Google.**
- `facebook-mediation`: **K·∫øt n·ªëi qu·∫£ng c√°o Facebook v√†o h·ªá th·ªëng AdMob mediation (hi·ªÉn th·ªã xen k·∫Ω).**
- `facebook-android-sdk`: **SDK Facebook c∆° b·∫£n, c·∫ßn cho ƒëƒÉng nh·∫≠p, token, v√† ads.**
- `vtn_ads_libs`: **Th∆∞ vi·ªán tu·ª≥ ch·ªânh (wrapper) gi√∫p b·∫°n d·ªÖ c·∫•u h√¨nh qu·∫£ng c√°o.**
- `shimmer`: **Hi·ªáu ·ª©ng ‚Äúloading‚Äù l·∫•p l√°nh (khi qu·∫£ng c√°o ch∆∞a t·∫£i xong).**

### C√°c lo·∫°i qu·∫£ng c√°o
- ‚úÖ **App Open Ads** - Hi·ªÉn th·ªã khi m·ªü ho·∫∑c resume app
- ‚úÖ **Interstitial Ads** - Qu·∫£ng c√°o to√†n m√†n h√¨nh
- ‚úÖ **Native Ads** - T√≠ch h·ª£p v√†o UI XML, Load ads native th√†nh c√¥ng s·∫Ω add ads v√†o view
- ‚úÖ **Banner Ads** - Qu·∫£ng c√°o banner ads (th∆∞·ªùng th·∫•y ·ªü layout bottomsheet c·ªßa m√†n HOME)
- ‚úÖ **Native Full Screen** - Load th√†nh c√¥ng Inter ADS s·∫Ω hi·ªán Native full ads to√†n m√†n h√¨nh ngay sau ƒë√≥

- `app_open_ads`: **Hi·ªÉn th·ªã khi ng∆∞·ªùi d√πng m·ªü ho·∫∑c quay l·∫°i ·ª©ng d·ª•ng (th∆∞·ªùng d√πng cho m√†n Splash ho·∫∑c Resume).**
- `interstitial_ads`: **Qu·∫£ng c√°o to√†n m√†n h√¨nh, th∆∞·ªùng xu·∫•t hi·ªán sau khi ng∆∞·ªùi d√πng ho√†n th√†nh m·ªôt h√†nh ƒë·ªông (v√≠ d·ª•: chuy·ªÉn sang m√†n kh√°c).**
- `native_ads`: **Qu·∫£ng c√°o t√πy bi·∫øn giao di·ªán, hi·ªÉn th·ªã nh∆∞ m·ªôt ph·∫ßn t·ª± nhi√™n trong ·ª©ng d·ª•ng.**
- `banner_ads`: **Qu·∫£ng c√°o k√≠ch th∆∞·ªõc nh·ªè, th∆∞·ªùng ƒë·∫∑t ·ªü cu·ªëi m√†n h√¨nh ch√≠nh (tr√™n thanh BottomTab).**
- `native_full_screen`: **D·∫°ng native chi·∫øm to√†n m√†n h√¨nh, th∆∞·ªùng xu·∫•t hi·ªán sau Interstitial Ads.**

---

## üöÄ C√ÅC B∆Ø·ªöC T√çCH H·ª¢P

### B∆Ø·ªöC 1: C·∫•u h√¨nh build.gradle (Root)

```gradle
allprojects {
    repositories {
        google()
        mavenCentral()
        maven { url 'https://jitpack.io' }
    }
}
```
- `repositories`: **Khai b√°o c√°c kho (repositories) ch·ª©a th∆∞ vi·ªán ƒë·ªÉ Gradle t·∫£i v·ªÅ.**
- `jitpack.io`: **L√† n∆°i l∆∞u th∆∞ vi·ªán `vtn_ads_libs` (v√¨ ƒë√¢y l√† package GitHub, kh√¥ng c√≥ s·∫µn tr√™n MavenCentral).**

### B∆Ø·ªöC 2: C·∫•u h√¨nh AndroidManifest.xml

```xml
<manifest>
    <!-- Permissions -->
    <uses-permission android:name="android.permission.INTERNET" />
    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
    <uses-permission android:name="com.google.android.gms.permission.AD_ID" />

    <application android:name=".MyApplication">
        
        <!-- Google AdMob App ID -->
        <meta-data
            android:name="com.google.android.gms.ads.APPLICATION_ID"
            android:value="@string/app_id" />

        <!-- Facebook App ID -->
        <meta-data
            android:name="com.facebook.sdk.ApplicationId"
            android:value="@string/facebook_app_id" />
        <meta-data
            android:name="com.facebook.sdk.ClientToken"
            android:value="@string/facebook_client_token" />
    </application>
</manifest>
```

### B∆Ø·ªöC 3: T·∫°o file ads_id.xml

**File**: `app/src/main/res/values/ads_id.xml`

```xml
<?xml version="1.0" encoding="utf-8"?>
<resources>
    <!-- Facebook -->
    <string name="facebook_app_id" translatable="false">YOUR_FB_APP_ID</string>
    <string name="facebook_client_token" translatable="false">YOUR_FB_CLIENT_TOKEN</string>
    <string name="adjust_token" translatable="false">YOUR_ADJUST_TOKEN</string>

    <!-- Google AdMob -->
    <string name="app_id" translatable="false">ca-app-pub-XXXXXXXX~XXXXXXXX</string>
    
    <!-- Test IDs (Development only) -->
    <!-- <string name="app_id">ca-app-pub-3940256099942544~3347511713</string> -->
    <!-- <string name="open_ads">ca-app-pub-3940256099942544/9257395921</string> -->
    <!-- <string name="inter_splash">ca-app-pub-3940256099942544/1033173712</string> -->
    <!-- <string name="native_all">ca-app-pub-3940256099942544/2247696110</string> -->
    <!-- <string name="banner_all">ca-app-pub-3940256099942544/9214589741</string> -->

    <!-- Real Ads IDs -->
    <string name="open_ads" translatable="false">ca-app-pub-XXXXXXXX/XXXXXXXX</string>
    <string name="inter_splash" translatable="false">ca-app-pub-XXXXXXXX/XXXXXXXX</string>
    <string name="native_home" translatable="false">ca-app-pub-XXXXXXXX/XXXXXXXX</string>
    <string name="banner_all" translatable="false">ca-app-pub-XXXXXXXX/XXXXXXXX</string>
    <!-- Th√™m c√°c ad units kh√°c... -->
</resources>
```

### B∆Ø·ªöC 4: T·∫°o Application Class

```kotlin
class MyApplication : AdsApplication() {

    override fun onCreate() {
        super.onCreate()
        RemoteConfig.init(this)

        // T·∫Øt App Open Ads cho m·ªôt s·ªë m√†n h√¨nh
        AppOpenManager.getInstance().disableAppResumeWithActivity(SplashActivity::class.java)
    }

    override fun enableAdsResume() = true
    override fun getResumeAdId() = RemoteConfig.open_ads
    override fun buildDebug() = BuildConfig.DEBUG
    override fun enableAdjustTracking() = true
    override fun getAdjustToken() = getString(R.string.adjust_token)
    override fun getKeyRemoteIntervalShowInterstitial() = "interval_show_interstitial"
    override fun getListTestDeviceId() = null
    override fun getIntentOpenNotification() = Intent(this, SplashActivity::class.java)
}
```

### B∆Ø·ªöC 5: C·∫•u h√¨nh Remote Config

**File**: `RemoteConfig.java`

```java
public class RemoteConfig {
    // Flags b·∫≠t/t·∫Øt ads
    public static Boolean is_load_inter_splash = true;
    public static Boolean is_load_native_home = true;
    public static Boolean is_load_banner_all = true;
    public static long interval_show_interstitial = 15L;
    
    // Ad IDs
    public static String open_ads = "";
    public static String inter_splash = "";
    public static String native_home = "";
    public static String banner_all = "";

    public static void init(Context context) {
        open_ads = context.getString(R.string.open_ads);
        inter_splash = context.getString(R.string.inter_splash);
        native_home = context.getString(R.string.native_home);
        banner_all = context.getString(R.string.banner_all);
    }
}
```

### B∆Ø·ªöC 6: Xin Consent (GDPR)

```kotlin
// Trong SplashActivity & MainActivity
private fun processAdConsent() {
    val consentHelper = ConsentHelper.getInstance(this)
    consentHelper.obtainConsentAndShow(this) {
        // Sau khi c√≥ consent, load ads
        loadAds()
    }
}
```

---

## üí° S·ª¨ D·ª§NG QU·∫¢NG C√ÅO

### 1. APP OPEN ADS

T·ª± ƒë·ªông ho·∫°t ƒë·ªông th√¥ng qua `AppOpenManager`. Ch·ªâ c·∫ßn config trong Application class.

```kotlin
// T·∫Øt App Open cho m√†n h√¨nh c·ª• th·ªÉ
AppOpenManager.getInstance().disableAppResumeWithActivity(MainActivity::class.java)

// B·∫≠t l·∫°i trong Activity
AppOpenManager.getInstance().enableAppResumeWithActivity(MainActivity::class.java)
```

---

### 2. INTERSTITIAL ADS

```kotlin
// Load v√† show c√πng l√∫c
private fun showInterstitial(nextAction: () -> Unit) {
    Admob.getInstance().loadAndShowInter(
        this,
        RemoteConfig.inter_splash,
        true, // show loading
        object : AdCallback() {
            override fun onNextAction() {
                nextAction.invoke()
            }
        }
    )
}

// Ho·∫∑c load v√† show v·ªõi Native Full Screen (tƒÉng fill rate)
private fun showInterWithNative(nextAction: () -> Unit) {
    Admob.getInstance().loadAndShowInterWithNativeFullScreen(
        this,
        RemoteConfig.inter_splash,
        RemoteConfig.native_full_splash,
        true,
        object : AdCallback() {
            override fun onNextAction() {
                nextAction.invoke()
            }
        }
    )
}
```

---

### 3. NATIVE ADS

**Layout XML:**
```xml
<FrameLayout
    android:id="@+id/native_ads_container"
    android:layout_width="match_parent"
    android:layout_height="wrap_content" />
```

**Code:**
```kotlin
private fun loadNativeAds() {
    Admob.getInstance().loadNativeAd(
        this,
        RemoteConfig.native_home,
        object : NativeCallback() {
            override fun onNativeAdLoaded(nativeAd: NativeAd?) {
                val adView = LayoutInflater.from(this@YourActivity)
                    .inflate(R.layout.native_ads_layout, null) as NativeAdView
                binding.nativeAdsContainer.removeAllViews()
                binding.nativeAdsContainer.addView(adView)
                Admob.getInstance().pushAdsToViewCustom(nativeAd, adView)
            }

            override fun onAdFailedToLoad() {
                binding.nativeAdsContainer.visibility = View.GONE
            }
        }
    )
}
```

**Preload Pattern (T·ªëi ∆∞u):**
```kotlin
// Singleton ƒë·ªÉ cache native ads
object AdsNativeConfig {
    var mNativeAdHome: NativeAd? = null
    
    fun loadNativeHome(context: Context) {
        if (mNativeAdHome == null) {
            Admob.getInstance().loadNativeAd(context, RemoteConfig.native_home, callback)
        }
    }
}

// Preload s·ªõm trong Application
AdsNativeConfig.loadNativeHome(this)

// Show khi c·∫ßn
AdsNativeConfig.showNativeHome(this, binding.nativeAdsContainer)
```

---

### 4. BANNER ADS

```kotlin
private fun loadBanner() {
    if (ConsentHelper.getInstance(this).canRequestAds() && 
        RemoteConfig.is_load_banner_all) {
        
        val config = BannerPlugin.Config()
        config.defaultAdUnitId = RemoteConfig.banner_all
        config.defaultBannerType = BannerPlugin.BannerType.Adaptive
        
        Admob.getInstance().loadBannerPlugin(
            this,
            binding.rlBanner,
            binding.include as ViewGroup,
            config
        )
        binding.loBanner.visibility = View.VISIBLE
    }
}
```

---

## ‚úÖ BEST PRACTICES

### 1. Ki·ªÉm tra ƒëi·ªÅu ki·ªán tr∆∞·ªõc khi show ads
```kotlin
private fun shouldShowAds(): Boolean {
    return RemoteConfig.is_load_inter_splash &&
            ConsentHelper.getInstance(this).canRequestAds() &&
            isNetworkAvailable(this) &&
            checkInterval()
}
```

### 2. Qu·∫£n l√Ω interval
```kotlin
private fun checkInterval(): Boolean {
    val lastTime = getSharedPreferences("app_prefs", MODE_PRIVATE)
        .getLong("last_show_ads", 0)
    val interval = RemoteConfig.interval_show_interstitial * 1000
    return (System.currentTimeMillis() - lastTime) >= interval
}

private fun saveLastShowTime() {
    getSharedPreferences("app_prefs", MODE_PRIVATE).edit()
        .putLong("last_show_ads", System.currentTimeMillis())
        .apply()
}
```

### 3. Preload ads
```kotlin
// Trong Application ho·∫∑c MainActivity
private fun preloadAds() {
    Handler(Looper.getMainLooper()).postDelayed({
        AdsNativeConfig.loadNativeHome(this)
        AdsInterConfig.loadInterTab(this)
    }, 2000)
}
```

### 4. X·ª≠ l√Ω khi ads fail
```kotlin
Admob.getInstance().loadInterAds(this, adId, object : AdCallback() {
    override fun onAdFailedToLoad(error: LoadAdError?) {
        // Kh√¥ng block user, cho ti·∫øp t·ª•c flow
        nextAction.invoke()
    }
})
```

### 5. Cleanup
```kotlin
override fun onDestroy() {
    super.onDestroy()
    mInterstitialAd = null
    mNativeAd?.destroy()
    mNativeAd = null
}
```

---

## üîß PROGUARD RULES

```proguard
# Google Ads
-keep class com.google.android.gms.ads.** { *; }
-keep interface com.google.android.gms.ads.** { *; }
-dontwarn com.google.android.gms.**

# Facebook Ads
-dontwarn com.facebook.infer.annotation.**

# Gson
-keep class com.google.gson.** { *; }
-keepattributes Signature
```

---

## ‚ö†Ô∏è L∆ØU √ù QUAN TR·ªåNG

| ‚ö†Ô∏è | N·ªôi dung                                                        |
|----|-----------------------------------------------------------------|
| **Test Ads IDs** | Ch·ªâ d√πng khi development, KH√îNG d√πng ·ªü production               |
| **Consent** | Lu√¥n ki·ªÉm tra `ConsentHelper.getInstance(this).canRequestAds()` |
| **Interval** | T√πy ch·ªânh gi√¢y gi·ªØa 2 l·∫ßn show Interstitial tr√™n RemoteConfig   |
| **Internet** | Ki·ªÉm tra k·∫øt n·ªëi tr∆∞·ªõc khi load ads                             |
| **Cleanup** | Destroy ads trong `onDestroy()`                                 |
| **Remote Config** | D√πng ƒë·ªÉ b·∫≠t/t·∫Øt ads t·ª´ xa m√† kh√¥ng c·∫ßn update app               |

---

## üéØ CHECKLIST TR∆Ø·ªöC KHI RELEASE

- [ ] ƒê√£ thay Test Ads IDs b·∫±ng Real Ads IDs
- [ ] File `google-services.json` ƒë√£ c·∫•u h√¨nh ƒë√∫ng
- [ ] Package name kh·ªõp v·ªõi AdMob console
- [ ] Meta-data `APPLICATION_ID` ƒë√£ th√™m v√†o Manifest
- [ ] Proguard rules ƒë√£ th√™m ƒë·∫ßy ƒë·ªß
- [ ] Test consent flow tr√™n thi·∫øt b·ªã th·∫≠t
- [ ] Test ads hi·ªÉn th·ªã b√¨nh th∆∞·ªùng
- [ ] Remote Config ƒë√£ setup tr√™n Firebase

---

## üìä C·∫§U TR√öC D·ª∞ √ÅN

```
app/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ main/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ java/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ com/yourpackage/
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ MyApplication.kt          # Application class
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ utils/
‚îÇ   ‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ RemoteConfig.java     # Remote config
‚îÇ   ‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ AdsNativeConfig.kt    # Native ads manager
‚îÇ   ‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ AdsInterConfig.kt     # Inter ads manager
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ res/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ native_ads_layout.xml     # Native ads layout
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ values/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ ads_id.xml                # Ads IDs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ AndroidManifest.xml
‚îÇ   ‚îú‚îÄ‚îÄ develop/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ google-services.json              # Development config
‚îÇ   ‚îî‚îÄ‚îÄ production/
‚îÇ       ‚îî‚îÄ‚îÄ google-services.json              # Production config
‚îú‚îÄ‚îÄ build.gradle
‚îî‚îÄ‚îÄ proguard-rules.pro
```

---

## üö® TROUBLESHOOTING NHANH

| V·∫•n ƒë·ªÅ | Gi·∫£i ph√°p                                                                                  |
|--------|--------------------------------------------------------------------------------------------|
| Ads kh√¥ng hi·ªÉn th·ªã | Ki·ªÉm tra remote config, consent, internet, Ad IDs ho·∫∑c m√°y ·∫£o th∆∞·ªùng kh√¥ng show native ads |
| Crash khi show ads | Ki·ªÉm tra context null, Activity destroyed                                                  |
| Facebook mediation kh√¥ng work | Ki·ªÉm tra Facebook App ID, Client Token                                                     |
| Proguard error | Th√™m keep rules cho ads classes                                                            |

---

**üéâ Ho√†n t·∫•t! B·∫Øt ƒë·∫ßu ki·∫øm ti·ªÅn t·ª´ qu·∫£ng c√°o!**

